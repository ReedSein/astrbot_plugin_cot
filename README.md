# 🧠 AstrBot Plugin CoT (罗莎核心思维链+重试插件)

> 赋予 AstrBot 深度思考的能力，记录每一次决策背后的“内心独白”，并提供企业级的智能重试保障。

本插件为 AstrBot 引入了完整的 **思维链 (Chain of Thought)** 处理机制。它拦截并解析 LLM 的原始响应，将“思考过程”与“最终回复”智能分离。配合强大的重试系统和精美的可视化功能，让你的 Bot 不仅更稳定，而且更具“人性”与深度。

---

## ✨ 功能特性 (Features)

### 1. 🧠 深度思维链管理
*   **双重锚点贪婪分割 (Dual Anchor Splitting)**：采用鲁棒的正则算法，自动寻找回复中**最后一次出现**的分隔符（支持配置主锚点及备用锚点 `[TEXTE FINAL] :`）。
*   **智能清洗**：自动剔除回复中的思维过程，防止 Bot 的“内心戏”直接泄露给用户。
*   **防截断保护**：当模型输出中断时，优先保护正文，宁可截断思考也不让乱码泄露。

### 2. 🛡️ 智能重试系统 (Intelligent Retry)
*   **多维异常检测**：自动识别 API 报错、网络超时、内容截断以及**思维结构缺失**。
*   **幽灵重试修复**：优化的状态机逻辑，杜绝了无意义的重复请求。
*   **指数退避策略**：在 API 不稳定时自动进行指数级延迟重试，提高成功率。
*   **静默拦截**：配合 `force_cot_structure` 配置，可强力拦截所有不符合格式的回复，确保人设不崩。

### 3. 🎨 古典主义可视化 (Classicism UI)
*   **沉浸式阅读**：指令生成的图片采用**古典主义风格**设计——羊皮纸纹理、衬线字体排版、拟真纸张阴影。
*   **Retina 高清渲染**：内置 High DPI 支持，视口宽广，文字锐利，完美适配高分屏设备。

### 4. 📝 完备的日志系统
*   **全量归档**：所有的思维链记录都会被按日归档保存。
*   **哨兵机制**：当模型未输出思考内容时，自动记录哨兵标记，查询时显示友好的兜底文案，而非报错。

---

## 🛠️ 使用指南 (Usage)

### 核心指令

| 指令 | 参数 | 描述 |
| :--- | :--- | :--- |
| `/rosaos` | `[index]` | **查看内心戏**。<br>获取当前会话最近的第 `index` 条思维链记录，并生成精美图片。<br>默认为 `1`（最新一条）。 |
| `/cogito` | `[index]` | **深度认知分析**。<br>调用小模型（如 GPT-3.5/4o-mini）对指定的思维链日志进行心理学分析，解读 Bot 当时的潜台词与情绪状态。 |

### 提示词集成 (Prompt Integration)

为了让插件正常工作，请在你的 System Prompt 中加入类似以下的要求：

> 在回答我的问题之前，请先进行深度的思维链思考。
> 思考结束后，请**务必**换行并输出“**最终的罗莎回复：**”，然后才是发给我的正文。

---

## ⚙️ 配置说明 (Configuration)

安装插件后，请在 AstrBot 的 Web 仪表盘中配置以下参数：

| 配置项 | 说明 | 默认值 |
| :--- | :--- | :--- |
| **强制 CoT 结构** (`force_cot_structure`) | **核心开关**。若开启，模型不输出分隔符将被视为失败并触发重试。强烈建议开启。 | `true` |
| **最终回复分隔正则** (`final_reply_pattern`) | 用于识别主锚点的正则表达式。 | `最终的罗莎回复[:：]?\s*` |
| **显示思维链文本** (`display_cot_text`) | 是否在直接回复中包含思维链（以 `🤔` 开头）。通常建议关闭。 | `false` |
| **最大重试次数** (`max_attempts`) | 请求失败或格式错误时的最大重试次数。 | `3` |
| **回复关键词过滤** (`filtered_keywords`) | 发送前自动剔除的敏感词列表。 | `["呵呵，", "（……）"]` |

---

## 🏆 致谢与版权 (Credits & Acknowledgements)

本插件的诞生离不开社区的智慧与贡献，特此致谢：

*   **插件作者 (Author)**: ReedSein
*   **特别致谢 (Special Thanks)**:
    *   **Intelligent Retry**: 感谢 **@muyouzhi6** 和 **@长安某**。本插件的智能重试机制深受其核心逻辑与灵感的启发。
    *   **CoT Inspiration**: 感谢 **MigitaRin** 和 **Nedvaknande**。正是他们的探索为思维链相关功能的实现提供了宝贵的灵感来源。

---

## 📄 许可证 (License)

本项目采用 **MIT 许可证** 开源。
